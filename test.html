<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pookalam Pie</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

  <style>
    /* -------------------------------------- */
    /* ------------ CORE VARIABLES ---------- */
    /* -------------------------------------- */
    :root{
      /* ---- Responsive Radii based on viewport min dimension ---- */
      --canvas-size: 60vmin;
      --game-radius-css: calc(var(--canvas-size) * 0.4); /* Used in CSS for text ring, JS will get actual pixel value */
      --ring-radius: calc(var(--canvas-size) * 0.433); /* Used in CSS for text ring */
      
      /* ---- Position tweaks (now responsive) ---- */
      --ring-x: 50%;
      --ring-y: 50%;
      --ring-dx: 0px;
      --ring-dy: 0px;
    }

    body {
      margin: 0;
      height: 100vh;
      width: 100vw;
      font-family: 'Press Start 2P', cursive, Arial, sans-serif;
      overflow: hidden;
      background: #fff8dc;
    }

    /* -------------------------------------- */
    /* -------------- LAYOUT ---------------- */
    /* -------------------------------------- */
    #mainLayout {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #gameContainer {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.6s ease;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    #gameTitle {
      position: absolute;
      top: 2.2vh; /* Relative to viewport height */
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 15px;
      font-family: 'Roboto', sans-serif;
      font-size: 5.5vmin; /* Relative to viewport dimensions */
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #fff;
      text-shadow: 0 0 6px rgba(255,255,255,0.6), 0 0 12px rgba(255,255,255,0.4);
      z-index: 20;
    }

    #gameTitle img {
      height: 9vmin; /* Relative to viewport dimensions */
      width: auto;
    }

    .panel {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      display: flex;
      flex-direction: row;
      gap: 30px;
      padding: 20px;
      border-radius: 15px;
      background: rgba(255,255,255,0);
      box-shadow: inset 0 0 15px rgba(0,0,0,0.2), 0 6px 10px rgba(0,0,0,0.2);
    }

    .column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .panel img {
      width: 55px;
      height: 55px;
      cursor: pointer;
      border-radius: 50%;
      transition: 0.2s;
    }

    .panel img:hover {
      outline: 2px solid gold;
    }

    .panel button {
      all: unset;
      padding: 8px 16px;
      font-size: 12px;
      cursor: pointer;
      text-align: center;
      display: inline-block;
      background: white;
      color: black;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .panel button:hover {
      background: #eee;
    }

    /* Make canvas occupy its responsive size */
    #pookalam {
      width: var(--canvas-size);
      height: var(--canvas-size);
      background: transparent;
    }

    /* ---- Decorative Images (now responsive) ---- */
    .gif-bg {
      position: absolute;
      top: 32.8vh; /* Calculated from original top:300px on 912px height */
      left: 4.7vw; /* Calculated from original left:90px on 1919px width */
      height: 54.8vh; /* Calculated from original height:500px on 912px height */
      width: auto;
    }

    .arrow-img {
      position: absolute;
      top: 39.5vh; /* Calculated from original top:360px on 912px height */
      left: 55.8vw; /* Calculated from original left:1070px on 1919px width */
      height: 32.9vh; /* Calculated from original height:300px on 912px height */
      width: auto;
    }

    /* -------------------------------------- */
    /* ------------ POPUP & DANCE ----------- */
    /* -------------------------------------- */
    #popupFull {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(255, 242, 0, 0.95);
      border: 10px solid #8b4513;
      box-shadow: 0 0 30px rgba(255, 140, 0, 0.6), inset 0 0 40px rgba(0,0,0,0.25);
      text-align: center;
      flex-direction: column;
      padding: 30px;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
    }

    #popupFull h1 { font-size: 3.5vmax; }
    #popupFull p { font-size: 1.5vmax; }

    #popupContinue {
      margin-top: 20px;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 700;
      font-family: 'Raleway', sans-serif;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #fff;
      background: linear-gradient(135deg, #ffeb3b, #ff4081);
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 64, 129, 0.4);
    }
    #popupContinue:hover {
      background: linear-gradient(135deg, #ff4081, #ffeb3b);
      box-shadow: 0 6px 20px rgba(255, 64, 129, 0.6);
      transform: translateY(-2px) scale(1.05);
    }

    #danceScreen {
      display: none;
      height: 100vh;
      width: 100vw;
      justify-content: center;
      align-items: center;
      text-align: center;
      animation: party-time 0.9s infinite;
      position: absolute;
      top: 0;
      left: 0;
      overflow: hidden;
      flex-direction: column;
      color: white;
      z-index: 9;
    }

    @keyframes party-time {
      0% { background-color: #F9C80E; }
      25% { background-color: #F86624; }
      50% { background-color: #EA3546; }
      75% { background-color: #662E9B; }
      100% { background-color: #43BCCD; }
    }

    .gif-bg-main {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      z-index: 1;
    }

    /* -------------------------------------- */
    /* -------- ORBITING TEXT RING -------- */
    /* -------------------------------------- */
    .text-ring-wrapper {
      position: absolute;
      top: calc(var(--ring-y) + var(--ring-dy));
      left: calc(var(--ring-x) + var(--ring-dx));
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 5;
    }

    .text-ring {
      --font-size: 1.5vmin; /* Responsive font size */
      --text-color: rgb(243, 237, 237);
      width: calc(var(--ring-radius) * 2);
      height: calc(var(--ring-radius) * 2);
      position: relative;
      border-radius: 50%;
      animation: spin 40s linear infinite;
    }

    .text-ring span {
      font-family: 'Pacifico', cursive;
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: 0 0;
      font-size: var(--font-size);
      color: var(--text-color);
      white-space: pre;
    }

    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }

    /* -------------------------------------- */
    /* ------------ BADGE (UNUSED) ---------- */
    /* -------------------------------------- */
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap');
  </style>
</head>
<body>

  <div id="popupFull">
    <h1>ðŸŒ¸ Let's make a pookalam! ðŸŒ¸</h1>
    <p style="text-align: left;">
      ðŸŒ¼ Pick your favorite flowers from 10 vibrant choices! ðŸŒ¼ðŸŒº <br><br>
      ðŸŒ¼ Decorate the glowing 1/8th slice of the pookalam with your design ðŸŽ¨ <br><br>
      ðŸŒ¼ Watch the magic as your pattern blossoms into a full, colorful pookalam! ðŸŒ¸ðŸŒˆ <br><br>
    </p>
    <button id="popupContinue">Continue</button>
  </div>

  <div id="danceScreen">
    <img class="gif-bg-main" src="https://i.pinimg.com/originals/57/e2/09/57e209296e586933febadf06e271a3d3.gif" alt="Dancing Guy">
    <audio id="bgMusic" src="onam_song.mp3" loop></audio>
  </div>

  <div id="gameContainer">
    <div id="mainLayout">
        <h1 id="gameTitle">
            <img src="logo.png" alt="Logo">
            Pookalam Pie
        </h1>

        <img src="https://i.pinimg.com/originals/57/e2/09/57e209296e586933febadf06e271a3d3.gif"
             alt="Cool Animated Background"
             class="gif-bg">

        <img src="arrow.png"
             alt="Arrow"
             class="arrow-img">

        <div id="container">
          <div class="text-ring-wrapper">
            <div class="text-ring" id="orbitText"></div>
          </div>

          <canvas id="pookalam"></canvas> </div>
    </div>

    <div class="panel">
      <div class="column">
        <img src="petgr.png" id="btn1" alt="Flower 1">
        <img src="petye.png" id="btn2" alt="Flower 2">
        <img src="petor.png" id="btn3" alt="Flower 3">
        <img src="petwh.png" id="btn4" alt="Flower 4">
        <img src="petpu.png" id="btn5" alt="Flower 5">
        <button id="doneBtn">Continue</button>
      </div>
      <div class="column">
        <img src="blf.png" id="btn6" alt="Flower 6">
        <img src="pif.png" id="btn7" alt="Flower 7">
        <img src="ref.png" id="btn8" alt="Flower 8">
        <img src="whf.png" id="btn9" alt="Flower 9">
        <img src="yef.png" id="btn10" alt="Flower 10">
        <button id="clearBtn">Clear</button>
      </div>
    </div>
  </div>
    
  <script>
    /* -------- TIMELINE -------- */
    const popupContinue = document.getElementById("popupContinue");
    const popupFull = document.getElementById("popupFull");
    const danceScreen = document.getElementById("danceScreen");
    const bgMusic = document.getElementById("bgMusic");
    const gameContainer = document.getElementById("gameContainer");

    popupContinue.addEventListener("click", () => {
      popupFull.style.display = "none";
      danceScreen.style.display = "flex";
      bgMusic.play().catch(()=>{});

      setTimeout(() => {
        danceScreen.style.display = "none";
        gameContainer.style.visibility = "visible";
        gameContainer.style.opacity = "1";
        initCanvasAndDraw(); // Initialize canvas after gameContainer is visible
      }, 3000);
    });

    /* -------- Orbiting Text Ring -------- */
    const orbitText = document.getElementById("orbitText");
    const lyrics = `Kiliye Kiliye 
Kiliye Kiliye Mani Mani Meghathoppil
oru Malar Nullaan Pookum Azhakin Azhake
Kiliye Kiliye Mani Mani Meghathoppil `;

    function setupOrbitText() {
        const ringRadius = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--ring-radius"));
        orbitText.innerHTML = ''; // Clear previous text
        const chars = lyrics.split("");
        const step = 360 / chars.length;
        chars.forEach((ch, i) => {
            const span = document.createElement("span");
            span.textContent = ch;
            span.style.transform = `rotate(${i * step}deg) translateY(-${ringRadius}px)`;
            orbitText.appendChild(span);
        });
    }

    /* -------- GAME -------- */
    const canvas = document.getElementById("pookalam");
    let ctx, centerX, centerY, gameRadius;

    // Function to initialize canvas dimensions and drawing parameters
    function initCanvasAndDraw() {
        ctx = canvas.getContext("2d");
        
        // Get the actual computed CSS width/height of the canvas element
        const computedStyle = getComputedStyle(canvas);
        canvas.width = parseFloat(computedStyle.width);
        canvas.height = parseFloat(computedStyle.height);

        centerX = canvas.width / 2;
        centerY = canvas.height / 2;
        // game-radius-css is a CSS variable, need to get its computed pixel value
        gameRadius = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--game-radius-css"));

        redraw(); // Initial draw
        setupOrbitText(); // Setup orbiting text after canvas is sized
    }

    // Call initCanvasAndDraw initially and on resize
    window.addEventListener("resize", () => {
        if (gameContainer.style.visibility === "visible") {
            initCanvasAndDraw();
        }
    });


    function drawBase() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath(); ctx.arc(centerX, centerY, gameRadius, 0, Math.PI * 2);
      ctx.fillStyle = "#fff8dc"; ctx.fill();

      ctx.beginPath(); ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, gameRadius, 0, Math.PI/4);
      ctx.closePath(); ctx.fillStyle="rgba(255,200,0,0.3)";
      ctx.fill();
    }

    const flowerImgs = {
      btn1:"petgr.png", btn2:"petye.png", btn3:"petor.png", btn4:"petwh.png", btn5:"petpu.png",
      btn6:"blf.png", btn7:"pif.png", btn8:"ref.png", btn9:"whf.png", btn10:"yef.png"
    };

    const loadedImgs = {};
    let imagesLoadedCount = 0;
    const totalImages = Object.keys(flowerImgs).length;

    // Preload images
    for(let key in flowerImgs){
        const img = new Image(); 
        img.src = flowerImgs[key]; 
        img.onload = () => {
            imagesLoadedCount++;
            if (imagesLoadedCount === totalImages && gameContainer.style.visibility === "visible") {
                redraw(); // Ensure draw after all images are loaded
            }
        };
        loadedImgs[key] = img;
    }

    let selectedImg=null, items=[];
    Object.keys(flowerImgs).forEach(key=>{
      document.getElementById(key).addEventListener("click",()=>{ selectedImg=loadedImgs[key]; });
    });

    canvas.addEventListener("click",(e)=>{
      if(!selectedImg) return;
      const rect=canvas.getBoundingClientRect();
      const x=e.clientX-rect.left, y=e.clientY-rect.top;
      const dx=x-centerX, dy=y-centerY, dist=Math.hypot(dx,dy);
      const angle=Math.atan2(dy,dx); const ang=angle<0?angle+2*Math.PI:angle;
      if(dist<=gameRadius && ang>=0 && ang<=Math.PI/4){
        // Store relative coordinates for drawing
        items.push({img:selectedImg, x_rel: dx, y_rel: dy}); 
        redraw();
      }
    });

    function drawItemsPreview(){ 
        items.forEach(it => {
            // Draw using relative coordinates + center
            ctx.drawImage(it.img, centerX + it.x_rel - 20, centerY + it.y_rel - 20, 40, 40);
        });
    }

    function drawFinalSlice(slice){ 
        items.forEach(it => { 
            ctx.save(); 
            ctx.translate(centerX, centerY); 
            ctx.rotate(slice * Math.PI / 4); 
            // Draw using the stored relative coordinates
            ctx.drawImage(it.img, it.x_rel - 20, it.y_rel - 20, 40, 40); 
            ctx.restore(); 
        }); 
    }

    function animateFinal(){ 
        ctx.clearRect(0,0,canvas.width,canvas.height); 
        ctx.beginPath(); 
        ctx.arc(centerX,centerY,gameRadius,0,Math.PI*2); 
        ctx.fillStyle="#fff8dc"; 
        ctx.fill(); 
        let slice=0; 
        function next(){ 
            drawFinalSlice(slice); 
            slice++; 
            if(slice < 8)setTimeout(next,400); 
            else triggerConfetti(); 
        } 
        next(); 
    }

    function redraw(){ 
        drawBase(); 
        if (imagesLoadedCount === totalImages) { // Only draw preview if images are loaded
             drawItemsPreview(); 
        }
    }

    document.getElementById("doneBtn").addEventListener("click",animateFinal);
    document.getElementById("clearBtn").addEventListener("click",()=>{items=[];redraw();});
    
    // Initial call to initCanvasAndDraw will happen after gameContainer is visible
    // and on resize.

    /* -------- Background color changing -------- */
    const colors = [
      "#1E90FF",
      "#6A0DAD",
      "#FF6700",
      "#8E44AD",
      "#E32636",
      "#FFC300"
    ];

    let index = 0;

    setInterval(() => {
      if (gameContainer.style.visibility === "visible") {
        document.body.style.backgroundColor = colors[index];
        index = (index + 1) % colors.length;
      }
    }, 575);

    /* Confetti (same as before) */
    class Progress{constructor(p={}){this.timestamp=null;this.duration=p.duration||1000;this.progress=0;this.delta=0;this.isLoop=!!p.isLoop;this.reset();}reset(){this.timestamp=null;}start(n){this.timestamp=n;}tick(n){if(this.timestamp){this.delta=n-this.timestamp;this.progress=Math.min(this.delta/this.duration,1);if(this.progress>=1&&this.isLoop)this.start(n);return this.progress;}return 0;}}
    class Confetti{constructor(p){this.parent=p.elm||document.body;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.width=p.width||this.parent.offsetWidth;this.height=p.height||this.parent.offsetHeight;this.length=p.length||120;this.yRange=p.yRange||this.height*2;this.progress=new Progress({duration:p.duration,isLoop:true});this.rotationRange=typeof p.rotationRange==="number"?p.rotationRange:10;this.speedRange=typeof p.speedRange==="number"?p.speedRange:10;this.sprites=[];this.canvas.style.cssText="display:block;position:absolute;top:0;left:0;pointer-events:none;z-index:2000;";this.render=this.render.bind(this);this.build();this.parent.appendChild(this.canvas);this.progress.start(performance.now());requestAnimationFrame(this.render);}build(){for(let i=0;i<this.length;i++){let c=document.createElement("canvas"),ct=c.getContext("2d");c.width=9;c.height=16;c.position={initX:Math.random()*this.width,initY:-c.height-Math.random()*this.yRange};c.rotation=(this.rotationRange/2)-Math.random()*this.rotationRange;c.speed=(this.speedRange/2)+Math.random()*(this.speedRange/2);ct.fillStyle=["#EF5350","#EC407A","#AB47BC","#7E57C2","#5C6BC0","#42A5F5","#29B6F6","#26C6DA","#26A69A","#66BB6A","#9CCC65","#D4E157","#FFEE58","#FFCA28","#FFA726","#FF7043","#8D6E63","#BDBDBD","#78909C"][(Math.random()*18)|0];ct.fillRect(0,0,9,16);this.sprites.push(c);}}render(n){let pr=this.progress.tick(n);this.canvas.width=this.width;this.canvas.height=this.height;for(let i=0;i<this.length;i++){this.ctx.save();this.ctx.translate(this.sprites[i].position.initX+this.sprites[i].rotation*50*pr,this.sprites[i].position.initY+pr*(this.height+this.yRange));this.ctx.rotate(this.sprites[i].rotation);this.ctx.drawImage(this.sprites[i],-9*Math.abs(Math.sin(pr*2*Math.PI*this.sprites[i].speed))/2,-16/2,9*Math.abs(Math.sin(pr*2*Math.PI*this.sprites[i].speed)),16);this.ctx.restore();}requestAnimationFrame(this.render);}}function triggerConfetti(){const conf=new Confetti({width:window.innerWidth,height:window.innerHeight,length:120,duration:5000});setTimeout(()=>{conf.canvas.remove();},5000);}
  </script>
</body>
</html>